# Build Image
FROM golang:1.21-alpine AS build

# ca-certificates pull in default CAs, without this https fetch from blockstore will fail
RUN apk add --no-cache make musl-dev gcc ca-certificates && update-ca-certificates

WORKDIR /tmp/crw



# Cache Go dependencies like this:
COPY go.mod go.sum ./
RUN go mod download

COPY cmd cmd
COPY config config
COPY http http
COPY model model
COPY node node
COPY sync sync
COPY utils utils
COPY db db

# Compile.
ENV CC=/usr/bin/gcc
ENV CGO_ENABLED=1
RUN go build -v -o crw ./cmd/main.go

# Main Image
FROM busybox

WORKDIR /app

COPY --from=build /tmp/crw/crw .
COPY --from=build /tmp/crw/config/config.json .

CMD ["./crw"]
